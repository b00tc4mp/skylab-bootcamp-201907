
var dictionary = [
    [
        {letter:'a', question:`Con la A. Que no es propio de la época de la que se trata.`, answer:['Anacrónico', 'Anacrónica'], status:0},
        {letter:'a', question:'Con la A. Poner algo en un rincón o lugar retirado.', answer:'Arrinconar', status:0},
        {letter:'a', question:'Con la A. Persona que interpreta un papel en una obra teatral, cinematográfica, radiofónica o televisiva.', answer:['Actor', 'Actriz'], status:0}
    ],
    [
        {letter:'b', question:'Con la B. Conjunto de bollos de diversas clases que se ofrecen para la venta o el consumo.', answer:'Bollería', status:0},
        {letter:'b', question:'Con la B. Que ocurre dos veces al año.', answer:'Bianual', status:0},
        {letter:'b', question:'Con la B. Bebida que se hace batiendo helado, leche u otros ingredientes.', answer:'Batido', status:0}
    ],
    [
        {letter:'c', question:'Con la C. Que tiene un precio alto o más alto de lo normal.', answer:['Caro', 'Cara'], status:0},
        {letter:'c', question:'Con la C. Persona que acompaña a otra y come y vive con ella.', answer:'Camarada', status:0},
        {letter:'c', question:'Con la C. Repetición molesta e importuna de algo.', answer:'Cantinela', status:0}
    ],
    [
        {letter:'d', question:'Con la D. Deponer y privar del reino a alguien, echarlo del trono.', answer:'Destronar', status:0},
        {letter:'d', question:'Con la D. Cuidado y actividad en ejecutar algo.', answer:'Diligencia', status:0},
        {letter:'d', question:'Con la D. Encadenamiento de los sucesos considerado como necesario y fatal.', answer:'Destino', status:0}
    ],
    [
        {letter:'e', question:'Con la E. Encargar a alguien que haga algo o que cuide de algo o de alguien.', answer:'Encomendar', status:0},
        {letter:'e', question:'Con la E. Dicho de un sonido: Agudo, desapacible y chirriante.', answer:'Estridente', status:0},
        {letter:'e', question:'Con la E. Conjunto de actores que constituyen una compañía teatral o que actúan en una obra.', answer:'Elenco', status:0}
    ],
    [
        {letter:'f', question:'Con la F. Muy delgado, con aspecto de pasar hambre.', answer:['Famélico', 'Famélica'], status:0},
        {letter:'f', question:'Con la F. Apellido del médico neurólogo austríaco padre del psicoanálisis.', answer:'Freud', status:0},
        {letter:'f', question:'Con la F. Caja o andas en que se lleva a enterrar a los difuntos.', answer:'Féretro', status:0}
    ],
    [
        {letter:'g', question:'Con la G. Caverna natural o artificial.', answer:'Gruta', status:0},
        {letter:'g', question:'Con la G. Que proporciona satisfacción.', answer:'Gratificante', status:0},
        {letter:'g', question:'Con la G. Mano o pie del animal, cuando están armados de uñas corvas, fuertes y agudas, como en el león y el águila.', answer:'Garra', status:0}
    ],
    [
        {letter:'h', question:'Con la H. Dar a alguien muestras de afecto o rendimiento con palabras o acciones que puedan serle gratas.', answer:'Halagar', status:0},
        {letter:'h', question:'Con la H. Que despide hedor.', answer:['Hediondo', 'Hedionda'], status:0},
        {letter:'h', question:'Con la H. Dicho de una persona: Vagabunda y ociosa, que no quiere trabajar..', answer:['Holgazán', 'Holgazana'], status:0}
    ],
    [
        {letter:'i', question:'Con la I. Dicho de una sentencia o de un fallo: Que no se puede apelar.', answer:'Inapelable', status:0},
        {letter:'i', question:'Con la I. Rasgos, temperamento o carácter distintivos y propios de un individuo o de una colectividad.', answer:'Idiosincrasia', status:0},
        {letter:'i', question:'Con la I. Organismo que desempeña una función de interés público, especialmente benéfico o docente.', answer:'Institución', status:0},
    ],
    [
        {letter:'j', question:'Con la J. Hombre alevoso, traidor.', answer:'Judas', status:0},
        {letter:'j', question:'Con la J. Animar con palmadas, ademanes y expresiones a los que bailan, cantan.', answer:'Jalear', status:0},
        {letter:'j', question:'con la J. Hebreo, que profesa la ley de Moisés.', answer:['Judío', 'Judía'], status:0}
    ],
    [
        {letter:'k', question:'Con la K. Persona que realiza una acción temeraria con propósito suicida o con riesgo de su vida.', answer:'Kamikaze', status:0},
        {letter:'k', question:'Con la K. Mamífero marsupial arborícola parecido a un oso pequeño, propio de los eucaliptales australianos.', answer:'Koala', status:0},
        {letter:'k', question:'Con la K. Natural de Kuwait, país de Asia, o de su capital.', answer:'Kuwaití', status:0},
    ],
    [
        {letter:'l', question:'Con la L. Alabanza afectada para ganar la voluntad de alguien.', answer:'Lisonja', status:0},
        {letter:'l', question:'Con la L. Persona o cosa que entorpece o detiene algo.', answer:'Lastre', status:0},
        {letter:'l', question:'Con la L. Lastimar, golpear, magullar, herir.', answer:'Lacerar', status:0}
    ],
        [
        {letter:'m', question:'Con la M. Herramienta de percusión compuesta de una cabeza, por lo común de hierro, y un mango, generalmente de madera.', answer:'Martillo', status:0},
        {letter:'m', question:'Con la M. Arte y destreza en enseñar o ejecutar algo.', answer:'Maestría', status:0},
        {letter:'m', question:'con la M. Sistema de gobierno en que los puestos de responsabilidad se adjudican en función de los méritos personales.', answer:'Meritocracia', status:0}
    ],
    [
        {letter:'n', question:'Con la N. Desmedida preferencia que algunos dan a sus parientes para las concesiones o empleos públicos.', answer:'Nepotismo', status:0},
        {letter:'n', question:'Con la N. grupo extinto de homínidos que vivió en gran parte de Europa y parte de Asia durante el Paleolítico medio.', answer:'Neandertal', status:0},
        {letter:'n', question:'Con la N. Médico y adivino francés famoso por su libro de profecías que supuestamente predicen eventos futuros.', answer:'Nostradamus', status:0},
    ],
    [
        {letter:'ñ', question:'Contiene la Ñ. Destreza, habilidad.', answer:'Maña', status:0},
        {letter:'ñ', question:'Contiene la Ñ. Dedo de tres falanges, situado en el lado exterior de la mano o del pie.', answer:'Meñique', status:0},
        {letter:'ñ', question:'Contiene la Ñ. Figura de persona, hecha generalmente de plástico, trapo o goma, que sirve de juguete o de adorno.', answer:['Muñeco', 'Muñeca'], status:0},
    ],
    [
        {letter:'o', question:'Con la O. Abundancia, riqueza y sobra de bienes.', answer:'Opulencia', status:0},
        {letter:'o', question:'Con la O. Forma de gobierno en la cual el poder político es ejercido por un grupo minoritario.', answer:'Oligarquía', status:0},
        {letter:'o', question:'Con la O. Idea inesperada, pensamiento, dicho agudo u original que ocurre a la imaginación..', answer:'Ocurrencia', status:0},
    ],
        [
        {letter:'p', question:'Con la P. Ciencia que estudia los organismos que han existido en el pasado de la Tierra a partir de sus restos fósiles.', answer:'Paleontología', status:0},
        {letter:'p', question:'Con la P. Dejar de hacer algo momentáneamente, con idea de realizarlo más adelante.', answer:'Posponer', status:0},
        {letter:'p', question:'Con la P. Cantidad que corresponde a cada partícipe en un reparto o distribución.', answer:'Porción', status:0}
    ],
    [
        {letter:'q', question:'Contiene la Q. Templo musulmán.', answer:'Mezquita', status:0},
        {letter:'q', question:'Contiene la Q. Echar mocos.', answer:'Moquear', status:0},
        {letter:'q', question:'Contiene la Q. Natural de Quebec, ciudad o provincia del Canadá.', answer:['Quebequés', 'Quebequesa'], status:0},
    ],
    [
        {letter:'r', question:'Con la R. Residuo de las cañas de la mies, que queda en la tierra después de segar.', answer:'Rastrojo', status:0},
        {letter:'r', question:'Con la R. Carcajada, risa estrepitosa y descompuesta.', answer:'Risotada', status:0},
        {letter:'r', question:'Con la R. Coloquialmente, persona tacaña.', answer:'Rata', status:0}
    ],
    [
        {letter:'s', question:'Con la S. Sumario o resumen.', answer:'Sinopsis', status:0},
        {letter:'s', question:'Con la S. Daño o deterioro que se hace en instalaciones, productos, etc., como procedimiento de lucha contra los patronos, contra el Estado o contra las fuerzas de ocupación en conflictos sociales o políticos.', answer:'Sabotaje', status:0},
        {letter:'s', question:'Con la S. Líquido espeso azucarado que se emplea en repostería y para elaborar refrescos.', answer:'Sirope', status:0}
    ],
    [
        {letter:'t', question:'Con la T. Coloquialmente, gripe.', answer:'Trancazo', status:0},
        {letter:'t', question:'Con la T. Que tiene tres fases.', answer:['Trifásico', 'Trifásica'], status:0},
        {letter:'t', question:'Con la T. Resbalón o tropezón.', answer:'Traspié', status:0}
    ],
    [
        {letter:'u', question:'Con la U. Plan, proyecto, doctrina o sistema deseables que parecen de muy difícil realización.', answer:'Utopía', status:0},
        {letter:'u', question:'Con la U. Apoderarse de una propiedad o de un derecho que legítimamente pertenece a otro, por lo general con violencia.', answer:'Usurpar', status:0},
        {letter:'u', question:'Con la U. Séptimo planeta del sistema solar.', answer:'Urano', status:0}
    ],
    [
        {letter:'v', question:'Con la V. Intensidad del sonido.', answer:'Volumen', status:0},
        {letter:'v', question:'Con la V. Persona descendiente de otra.', answer:'Vástago', status:0},
        {letter:'v', question:'Con la V. Cada uno de los vasos o conductos por donde retorna la sangre al corazón.', answer:'Vena', status:0}
    ],
    [
        {letter:'w', question:'Con la W. Reproductor portátil de casetes provisto de auriculares.', answer:'Walkman', status:0},
        {letter:'w', question:'Con la W. Sistema de conexión inalámbrica entre dispositivos electrónicos, y frecuentemente para acceso a internet.', answer:'Wifi', status:0},
        {letter:'w', question:'Con la W. Deporte que consiste en deslizarse por el agua sobre una tabla especial provista de una vela.', answer:'Windsurf', status:0}
    ],
    [
        {letter:'x', question:'Contiene la X. Dicho de una persona: Inclinada sexualmente hacia individuos de uno y otro sexo.', answer:'Bisexual', status:0},
        {letter:'x', question:'Contiene la X. Perteneciente o relativo a la quijada o mandíbula.', answer:'Maxilar', status:0},
        {letter:'x', question:'Contiene la X. Que no admite discusión.', answer:['Taxativo', 'Taxativa'], status:0},
    ],
    [
        {letter:'y', question:'Con la Y. Unidad monetaria de China.', answer:'Yuan', status:0},
        {letter:'y', question:'Contiene la Y. Regla fija a la que está sometido un fenómeno de la naturaleza.', answer:'Ley', status:0},
        {letter:'y', question:'Con la Y. Hembra del caballo.', answer:'Yegua', status:0},
    ],
    [
        {letter:'z', question:'Con la Z. Apellido del director de la trilogía Regreso al Futuro.', answer:'Zemeckis', status:0},
        {letter:'z', question:'Contiene la Z. Buscar o perseguir aves, fieras y otras muchas clases de animales para cobrarlos o matarlos.', answer:'Cazar', status:0},
        {letter:'z', question:'Contiene la Z. Polvo de color gris claro que queda después de una combustión completa.', answer:'Ceniza', status:0}
    ],
]

var rankings = JSON.parse(localStorage.getItem('rankings'))

if (!rankings) {
    rankings = [
        {username:'John', points:27},
        {username:'Paul', points:26},
        {username:'Ringo', points:25},
        {username:'George', points:24}
    ];
}

var counter = 0;
var username = '';

// Randomize dictionary to take only 1 out of 3 options per letter
var letters  = randomizeDictionary(dictionary);


function randomizeDictionary(dictionary) {
/* Returns array of objects with only one question per letter from a dictionary that can have multiple */

    // Create shallow copy of dictionary (for restarts)
    var newDict = JSON.parse(JSON.stringify(dictionary)); 
    var gameDict = newDict.map(function(questions, idx, []) {
        var randomNum = Math.floor(Math.random() * questions.length)
        return questions[randomNum]
    })
    
    return gameDict
}

function getUsername() {

    document.querySelector('.start-container').style.display = 'none';
    document.querySelector('.username-container').classList.add('active');
    document.querySelector('.username-container').classList.remove('hidden');
    document.querySelector('.username-input').focus();
}

function roscoLayout(letters) {
/* Draws rosco layout based on number of letters in dictionary */

    document.querySelector('.username-container').style.display = 'none';
    document.querySelector('.main-container').classList.add('active');

    var slice = 360 / letters.length;
    var rotation = 266.667; // start at 12 o'clock
    var rosco = document.querySelector('.rosco');
    if (window.innerWidth <= 830) {
        var radius =  26 + 'vw';
    } else if (window.innerWidth <= 1200) {
        var radius = 18 + 'vw';
    } else if (window.innerWidth >= 1201) {
        var radius = 14 + 'vw';
    }

    letters.forEach(function(letter) {
        var letterDiv = document.createElement('div');
        letterDiv.classList.add('letter');
        letterDiv.id = letter['letter'] 
        rosco.appendChild(letterDiv)
        letterDiv.style.transform = `rotate(${rotation}deg) translate(${radius}) rotate(-${rotation}deg)`;
        letterDiv.innerHTML = letter['letter'].toUpperCase()
        rotation += slice;
    })

}


function startGame(name) {

    // Set username (global scope)
    if (!name.trim()) {
        return false;
    }
    username = name;
    var usernameFound = false;
    rankings.forEach(function(obj) {
        if (obj.username === username) {
            obj.points = 0
            usernameFound = true;
        }
    })

    if (!usernameFound) {
        rankings.push({username:username, points:0})
    }

    // Generate rosco
    roscoLayout(letters);

    // Show first question
    nextQuestion()

    // Start countdown
    countDown(200);
}

function nextQuestion() {

    // Check if game is over
    var endGame = checkGameEnd();
    if (endGame) {
        gameOver('letters')
        return true;
    }

    // Reset for second, third, four... rounds
    if (counter === letters.length) {
        counter = 0
    }

    var letter = letters[counter]

    // Check next questions to be shown
    if (letters[counter].status === 0) {
        var questionHeader = letter.question.split('.')[0];
        var questionText = letter.question.split('.')[1];
        document.querySelector('.question-header').textContent = questionHeader;
        document.querySelector('.question-text').textContent = questionText;
        document.querySelector('.core').textContent = letter.letter.toUpperCase();
        document.querySelector('.answer-input').focus();
    } else {
        counter++;
        nextQuestion();
    }
    return false;
}

function checkAnswer(input) {

    if (!input.trim()) {
        return false;
    }

    var inputAnswer = document.querySelector('.answer-input');
    inputAnswer.textContent = ''

    // Reset counter
    var answer = letters[counter].answer
    if (typeof(answer) === 'string') {
        var answerLower = [answer.toLowerCase()];
    } else {
        var answerLower = answer.map(i => i.toLowerCase());
    }

    var currentLetter = letters[counter].letter
    input = input.toLowerCase();

    if (input === 'pasapalabra') {var restartRanking = document.querySelector('.restart-ranking-button');
    restartRanking.addEventListener('click', getUsername, false)

    } else {
        var correct = answerLower.some(function(answer) {
            if (answer === input) {
                return true;
            } else {
                return false;
            }
        })

        if (correct) {
            var letterElem = document.querySelector(`#${currentLetter}`)
            letterElem.classList.add('correct');
            letters[counter].status = 1;
            var answered = document.querySelector('.answered-content')
            answered.textContent = parseInt(answered.textContent) + 1;
            rankings.forEach(function(obj) {
                if (obj.username === username) {
                    obj.points += 1
                }
            })
        } else {
            var letterElem = document.querySelector(`#${currentLetter}`)
            letterElem.classList.add('incorrect');
            letters[counter].status = 2;
        }
    }

    counter++;
    nextQuestion()
}

function checkGameEnd() {

     var endGame = letters.every(function(letter) {
        if (letter.status !== 0) {
            return true;
        }
    })
    return endGame;
}

function gameOver(reason) {

    document.querySelector('.main-container').style.display = 'none';
    document.querySelector('.endgame-container').style.display = 'flex';
    document.querySelector('.endgame-container').classList.add('active');
    document.querySelector('.endgame-container').classList.remove('hidden');

    var correctAnswers = document.querySelector('.answered').textContent

    if (reason === 'time') {
        document.querySelector('.endgame-content').textContent = `¡Se acabó el tiempo! Enhorabuena, has acertado ${correctAnswers} letras.`
    } else {
        document.querySelector('.endgame-content').textContent = `¡Rosco completo! Enhorabuena, has acertado ${correctAnswers} letras.`
    }

}

function countDown(startTime) {
    var timeLeft = document.querySelector('.timer-content');
    var timer = setInterval(() => {
        startTime--;
        timeLeft.textContent = startTime;
        if (startTime <= 0) {
            clearInterval(timer)
            gameOver('time');
        }  
    }, 1000);
}

function showRanking() {

    document.querySelector('.endgame-container').style.display = 'none';
    document.querySelector('.ranking-container').style.display = 'flex';
    document.querySelector('.ranking-container').classList.add('active');
    document.querySelector('.ranking-container').classList.remove('hidden');

    var rankingList = document.querySelector('.ranking-list');
    while (rankingList.firstChild){
        rankingList.removeChild(rankingList.firstChild);
    }

    rankings.sort(function(a, b) {
        if ( a.points < b.points ){
            return 1;
        }
        if ( a.points > b.points ){
            return -1;
        }
        return 0;
    });

    var topTen = rankings.slice(0, 10)
    
    topTen.forEach(function(user) {
        var ol = document.querySelector('.ranking-list');
        var li = document.createElement('li');
        li.textContent = `${user.username} (${user.points} aciertos)`
        ol.appendChild(li)
    })

    localStorage.setItem('rankings', JSON.stringify(rankings));

}

function checkViewPort() {

    var letter = document.querySelector('.letter');
    if (letter) {
        var transf = letter.style.transform;
        if (window.innerWidth <= 830 && !transf.includes('26vw')) {
            window.location = window.location;
            return false;
        } else if (window.innerWidth <= 1200  && !transf.includes('18vw')) {
            window.location = window.location;
            return false;
        } else if  (window.innerWidth >= 1201 && !transf.includes('14vw')) {
            window.location = window.location;
            return false;
        }
    }
}

function restart() {
    window.location = window.location;
}

// Event listeners
var startButton = document.querySelector('.start-button');
startButton.addEventListener('click', getUsername, false);

var readyButton = document.querySelector('.ready-button');
var inputUsername = document.querySelector('.username-input');
readyButton.addEventListener('click', function() {startGame(inputUsername.textContent)}, false);
inputUsername.addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
        startGame(inputUsername.textContent);
    }
})

var inputAnswer = document.querySelector('.answer-input')
var submitAnswer = document.querySelector('.answer-submit')
var passAnswer = document.querySelector('.answer-pass');
passAnswer.addEventListener('click', function() {checkAnswer('pasapalabra')}, false);
submitAnswer.addEventListener('click', function() {checkAnswer(inputAnswer.textContent)}, false);
inputAnswer.addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
        checkAnswer(inputAnswer.textContent);
    }
})

var restartEnd = document.querySelector('.restart-endgame-button');
restartEnd.addEventListener('click', restart, false);

var restartRanking = document.querySelector('.restart-ranking-button');
restartRanking.addEventListener('click', restart, false);

var rankingButton = document.querySelector('.rankings-button');
rankingButton.addEventListener('click', showRanking, false);

window.addEventListener('resize', checkViewPort);